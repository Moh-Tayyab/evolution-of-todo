<!--
Sync Impact Report:
Version change: 1.0.0 → 1.2.0
Modified principles: Added Principle VII (Automated Compliance), enhanced all principles with enforcement metrics
Added sections:
  - Principle VII: Automated Compliance Verification
  - Violation Escalation Matrix
  - Phase Transition Gates
  - Phase-Specific Security Requirements
  - Phase-Specific Testing Requirements
  - Emergency Amendment Protocol
Removed sections: Verbose rationale paragraphs (moved to history/adr/001-constitution-rationale.md)
Templates requiring updates:
  ⚠️ .specify/templates/plan-template.md - Add Phase Transition Gates checklist
  ⚠️ .specify/templates/spec-template.md - Add automated compliance checks reference
  ⚠️ .specify/templates/tasks-template.md - Add phase-specific test tasks
  ⚠️ .github/workflows/*.yml - Add CI enforcement for spec traceability and coverage
  ⚠️ CLAUDE.md (root/frontend/backend) - Add compliance verification guidance
Follow-up TODOs:
  - Create ADR 001 with moved rationale content
  - Implement CI checks for spec traceability
  - Create phase transition gate scripts
-->

# Evolution of Todo - Project Constitution

## Core Principles

### I. Spec-Driven Development (SDD) as Core Workflow

Every feature, phase, and implementation MUST follow the SDD lifecycle: Specify (WHAT) → Plan (HOW) → Tasks (BREAKDOWN) → Implement (CODE). No manual coding allowed; all code MUST be generated by Claude Code based on refined specs.

**Enforcement**: CI MUST fail builds where code files lack spec reference comments. Target: 100% traceability.

### II. AI-Native Architecture

Use AI agents (Claude Code, OpenAI Agents SDK) for execution, with humans as product architects. Humans define architecture; AI generates implementation.

**Enforcement**: All code commits MUST include PHR reference documenting the AI generation process.

### III. Progressive Evolution

Build incrementally across 5 phases: console app → web app → AI chatbot → local K8s → cloud deployment. Each phase MUST be fully functional before proceeding to next.

**Enforcement**: Phase transition gates (see Phase Transition Gates section) MUST pass before advancing.

### IV. Cloud-Native and Event-Driven Focus

Prioritize stateless designs, loose coupling via Kubernetes, Dapr, and Kafka. Services MUST be horizontally scalable and resilient.

**Enforcement**: Architecture reviews MUST verify statelessness (no in-memory session state). Load tests MUST demonstrate horizontal scaling.

### V. Reusability and Intelligence

Create reusable AI components (Subagents, Skills) and cloud-native blueprints. Intelligence MUST be captured and shared.

**Enforcement**: Bonus points require published reusable components with usage documentation and examples.

### VI. Security and User Isolation

Enforce authentication, JWT-based authorization, and per-user data isolation. Zero tolerance for security vulnerabilities.

**Enforcement**: Automated security scans MUST pass (OWASP Top 10 checks). Manual penetration testing required before Phase V deployment.

### VII. Automated Compliance Verification

All compliance checks MUST be automated in CI/CD pipelines. Manual verification is insufficient for governance.

**Enforcement Mechanisms**:
- **Spec Traceability**: CI script scans all `.py`, `.ts`, `.tsx` files for `@spec:` references. Fails if <100%
- **Test Coverage**: CI fails if coverage <80% for core features (task CRUD, auth, events)
- **Security Scan**: CI runs `safety check` (Python), `npm audit` (Node), fails on HIGH/CRITICAL
- **Phase Gates**: Automated checklist validation before phase transitions (see Phase Transition Gates)

## Phase-Specific Requirements

### Phase I: Console App (Python 3.13+, UV)

**Tech Stack**: Python 3.13+, UV, Claude Code, Spec-Kit Plus

**Security**:
- N/A (single-user, in-memory)

**Testing**:
- Unit tests for task CRUD operations
- Integration tests for CLI commands
- Coverage: ≥80% for core logic

**Success Criteria**:
- All Basic features functional (CRUD + Complete)
- Tests pass
- Spec traceability: 100%

### Phase II: Web App (Next.js 16+, FastAPI, PostgreSQL)

**Tech Stack**: Next.js 16+ (App Router, TypeScript, Tailwind), FastAPI, SQLModel, Neon PostgreSQL, Better Auth (JWT)

**Security**:
- JWT authentication with 24h expiration
- All user-scoped tables MUST have `user_id` foreign key + index
- Input validation via Pydantic (backend) + Zod (frontend)
- HTTPS enforced (development: self-signed cert acceptable)
- Secrets in `.env` files (NEVER committed to Git)

**Testing**:
- Unit tests: models, services, utilities
- Integration tests: API endpoints with auth
- E2E tests: Critical user flows (login, create task, complete task)
- Coverage: ≥80% backend, ≥70% frontend

**Success Criteria**:
- All Basic + Intermediate features functional
- E2E tests pass in CI
- Security scan: no HIGH/CRITICAL vulnerabilities
- Spec traceability: 100%

### Phase III: AI Chatbot (OpenAI ChatKit, Agents SDK, MCP)

**Tech Stack**: OpenAI ChatKit (frontend), OpenAI Agents SDK, Official MCP SDK, stateless MCP server

**Security**:
- Rate limiting: 60 requests/minute per user
- Input sanitization for natural language queries (prevent prompt injection)
- MCP tools MUST validate user_id before DB operations
- All state persisted to PostgreSQL (NO in-memory sessions)

**Testing**:
- Contract tests: MCP tool schemas
- Integration tests: Agent workflows (add task, search, complete)
- AI quality tests: Validate responses for 20+ sample queries (accuracy, hallucination checks)
- Coverage: ≥80% MCP server, ≥70% agent code

**Success Criteria**:
- All Basic + Intermediate + Advanced features via natural language
- AI quality tests: ≥90% accuracy on sample queries
- Rate limiting functional
- Spec traceability: 100%

### Phase IV: Local Kubernetes (Docker, Minikube, Helm)

**Tech Stack**: Docker, Minikube, Helm Charts, kubectl-ai, Kagent

**Security**:
- Kubernetes secrets for database credentials, JWT signing key
- Network policies: backend/frontend isolation
- RBAC: Minimal permissions for service accounts

**Testing**:
- Helm chart validation: `helm lint`, `helm template` tests
- Deployment tests: Install chart, verify all pods Running, run smoke tests
- Rollback tests: Deploy v2, rollback to v1, verify functionality
- Coverage: Chart tests + existing app tests

**Success Criteria**:
- Deploys to fresh Minikube cluster in ≤15 minutes
- All services healthy (readiness/liveness probes pass)
- Rollback tested and functional
- Spec traceability: 100%

### Phase V: Cloud Production (Dapr, Kafka, DOKS, CI/CD)

**Tech Stack**: Dapr, Kafka (Redpanda Cloud/Strimzi), DigitalOcean DOKS, GitHub Actions

**Security**:
- Dapr secrets for all credentials
- JWT token rotation: 24h expiration, refresh tokens
- Audit logging: All user actions logged with timestamp, user_id, action
- HTTPS with valid TLS cert (Let's Encrypt)
- Network policies: Zero-trust (explicit allow rules only)

**Testing**:
- Load tests: Verify p95 latency <500ms at 100 concurrent users
- Chaos tests: Kill random pod, verify recovery <30s
- Event tests: Verify Kafka message delivery, dead-letter queue handling
- Security tests: Penetration testing report (OWASP Top 10)
- Coverage: Existing tests + production readiness tests

**Success Criteria**:
- Cloud deployment accessible via public URL
- Load tests pass (p95 <500ms)
- Chaos tests pass (recovery <30s)
- Security: Penetration test report with 0 HIGH/CRITICAL issues
- Observability: Centralized logs, metrics dashboards, alerts configured
- CI/CD: Automated deploy on merge to main
- Spec traceability: 100%

## Key Standards

### Development Process

**Spec-Kit Plus Structure**:
- `/specs/overview.md` - Project overview
- `/specs/features/*.md` - Feature specs with user stories
- `CLAUDE.md` - Agent guidance (root, frontend, backend)
- All specs MUST include: user stories, acceptance criteria, artifact links

**Spec References in Code**:
```python
# @spec: specs/features/001-task-crud.md
# User Story 1: Create Task
def create_task(user_id: int, title: str) -> Task:
    ...
```

**Enforcement**: CI script validates `@spec:` comments exist in all source files.

### Tech Stack Compliance

See Phase-Specific Requirements above for full tech stack per phase.

**Non-Negotiable**:
- Phase I: Python 3.13+, UV
- Phase II: Next.js 16+, FastAPI, SQLModel, Neon PostgreSQL, Better Auth
- Phase III: OpenAI ChatKit, OpenAI Agents SDK, Official MCP SDK
- Phase IV: Docker, Minikube, Helm
- Phase V: Dapr, Kafka, DigitalOcean DOKS (or AKS/GKE/OKE with ADR justification)

### Code Standards

**Clean Code** (MUST):
- Follow PEP 8 (Python), ESLint/Prettier (TypeScript)
- Meaningful names (no single-letter except loop counters)
- Explicit error handling (no bare try/except or empty catch)

**Database** (MUST):
- SQLModel ORM only
- `user_id` foreign key + index on all user-scoped tables
- Migrations for schema changes (Alembic)

**API** (MUST):
- Pydantic input validation
- Consistent error format: `{"error": "message", "code": "ERROR_CODE"}`
- Auth middleware on protected endpoints
- MCP tools stateless, DB-persisted state

**Event-Driven** (MUST):
- Kafka events for state changes (task created, completed, etc.)
- Event schema: `{"event_type": str, "timestamp": ISO8601, "user_id": int, "payload": dict}`
- Retry with exponential backoff, dead-letter queue for failures

**Testing** (MUST):
- TDD: Red-Green-Refactor
- Coverage: ≥80% core features
- Tests in specs before implementation

**Documentation** (MUST):
- `README.md`: Setup, prerequisites, quickstart
- `CLAUDE.md`: Agent constraints, patterns, pitfalls
- `history/`: Preserve all specs, PHRs, ADRs

### Monorepo Structure

```
Root:
├── .spec-kit/config.yaml
├── .github/workflows/          # CI/CD with compliance checks
├── specs/
│   ├── overview.md
│   └── features/
├── CLAUDE.md
├── frontend/
│   ├── src/
│   └── CLAUDE.md
├── backend/
│   ├── src/
│   └── CLAUDE.md
├── docker-compose.yml
├── helm/                       # Phase IV: Helm charts
└── history/
    ├── prompts/
    └── adr/
```

### Bonus Standards

**If Pursuing Bonuses** (Optional):
- Reusable components: Published with usage docs + examples
- Blueprints: Deployment instructions + config templates
- Multi-language (Urdu): MUST not break English flows (separate test suite)
- Voice commands: Same functionality as text (accessibility tests)

## Constraints

### No Manual Coding

All code MUST be Claude Code-generated from specs.

**Enforcement**: PRs MUST include PHR reference. Reviewers MUST verify PHR exists and matches changes.

### Phase Dependencies

Phases MUST be completed sequentially. Phase N+1 blocked until Phase N passes transition gates.

**Enforcement**: See Phase Transition Gates section below.

### Stateless Design

Services MUST be stateless. All session state in PostgreSQL.

**Enforcement**: Code reviews MUST reject in-memory session storage. Load tests MUST verify multi-instance compatibility.

### Deployment

- Phase IV: Minikube (local)
- Phase V: DigitalOcean DOKS (or AKS/GKE/OKE with ADR)

### Resource Limits

Free tiers ONLY: Neon free DB, Redpanda Serverless, DigitalOcean $200 credit.

**Enforcement**: Cost tracking MUST be documented. Overruns require architect approval.

### Feature Scope

**Exact Features per Level**:
- Basic: CRUD + Complete
- Intermediate: Priorities, Tags, Search, Filter, Sort
- Advanced: Recurring, Due dates, Reminders

**Enforcement**: Feature additions require spec amendment + constitution compliance check.

### Bonus Constraints

Bonus features MUST NOT degrade core performance/stability.

**Enforcement**: Separate test suites MUST verify non-interference.

### Submission

- Public GitHub repo
- Demo video ≤90 seconds
- WhatsApp contact included

## Phase Transition Gates

Each phase MUST pass these gates before advancing:

### Phase I → Phase II Gate

- [ ] All Basic features functional (manual demo)
- [ ] Unit + integration tests pass
- [ ] Test coverage ≥80%
- [ ] Spec traceability: 100% (automated check)
- [ ] Demo video recorded
- [ ] Phase I ADR created (technology choices)

### Phase II → Phase III Gate

- [ ] All Basic + Intermediate features functional
- [ ] E2E tests pass in CI
- [ ] Security scan: 0 HIGH/CRITICAL vulnerabilities
- [ ] JWT auth functional (manual test)
- [ ] Database migrations tested (up + down)
- [ ] Test coverage: ≥80% backend, ≥70% frontend
- [ ] Spec traceability: 100%
- [ ] Demo video recorded
- [ ] Phase II ADR created (architecture decisions)

### Phase III → Phase IV Gate

- [ ] All Basic + Intermediate + Advanced features via NL
- [ ] AI quality tests: ≥90% accuracy
- [ ] Rate limiting functional (load test)
- [ ] MCP tools contract tests pass
- [ ] Stateless design verified (multi-instance test)
- [ ] Test coverage: ≥80% MCP server
- [ ] Spec traceability: 100%
- [ ] Demo video recorded
- [ ] Phase III ADR created (AI architecture)

### Phase IV → Phase V Gate

- [ ] Helm chart deploys to Minikube in ≤15 minutes
- [ ] All pods Running + readiness probes pass
- [ ] Rollback tested (v2→v1 successful)
- [ ] Kubernetes secrets configured correctly
- [ ] Network policies functional
- [ ] Smoke tests pass post-deployment
- [ ] Test coverage maintained
- [ ] Spec traceability: 100%
- [ ] Demo video recorded
- [ ] Phase IV ADR created (K8s architecture)

### Phase V Completion Gate

- [ ] Cloud deployment accessible (public URL)
- [ ] Load tests: p95 <500ms at 100 users
- [ ] Chaos tests: Recovery <30s
- [ ] Penetration test: 0 HIGH/CRITICAL issues
- [ ] Observability: Logs, metrics, alerts configured
- [ ] CI/CD: Automated deploy functional
- [ ] Event-driven: Kafka integration tested
- [ ] JWT rotation functional
- [ ] Audit logging verified
- [ ] Test coverage maintained
- [ ] Spec traceability: 100%
- [ ] Final demo video recorded
- [ ] Phase V ADR created (production architecture)

**Enforcement**: Project lead MUST sign off on gate checklist before advancing.

## Violation Escalation Matrix

| **Severity** | **Violation Examples** | **Consequence** | **Remediation** |
|-------------|----------------------|----------------|-----------------|
| **P0 - Critical** | Security vulnerability (HIGH/CRITICAL), Manual coding without spec, Spec traceability <90% | PR blocked, immediate fix required | Fix within 24h or revert changes |
| **P1 - High** | Test coverage <80%, Missing phase gate item, Tech stack violation | PR blocked, fix before merge | Fix within 48h, escalate to architect if blocked |
| **P2 - Medium** | Missing documentation, Incomplete PHR, Weak error handling | PR approved with conditions | Fix within 1 week, tracked in follow-up task |
| **P3 - Low** | Code style violations, Missing comments, Minor documentation gaps | PR approved, non-blocking | Fix opportunistically, batch with related changes |

**Escalation Path**: Developer → Tech Lead → Project Architect → Constitution Amendment

**Override Authority**: Only Project Architect can override P0/P1 violations with explicit written justification in PR.

## Success Criteria

### Full Phase Completion

All 5 phases with working deliverables + demo videos + passing tests.

**Verification**: Phase transition gates MUST all pass.

### Spec-Driven Fidelity

100% code traceability to specs.

**Verification**: CI automated check for `@spec:` comments in all source files.

### Functionality Verification

**Per Phase**: See Phase-Specific Requirements above.

**Automated Tests**: All tests MUST pass in CI before merge.

### Deployment Stability

**Phase IV**: Minikube deploy ≤15 min, rollback functional
**Phase V**: Cloud deploy accessible, p95 <500ms, chaos recovery <30s

**Verification**: Automated deployment tests + load tests in CI.

### Bonus Achievement

Up to +600 points:
- Reusable intelligence (Subagents/Skills): +200
- Cloud-native blueprints: +150
- Multi-language (Urdu): +150
- Voice commands: +100

**Verification**: Published artifacts + demo video showing functionality.

### Overall Quality

Zero HIGH/CRITICAL vulnerabilities. Total points ≥1,000.

**Security**: Automated scans + penetration testing report.

**Quality Gates**: All tests pass, coverage ≥80%, dependency scans clean, PHRs complete.

### Alignment Check

All artifacts comply with constitution.

**Verification**: Phase gate checklists + automated CI checks.

## Governance

### Amendment Process

**Requirements**:
1. Documented rationale
2. Impact analysis
3. Migration plan
4. Architect approval

**Version Bumping**:
- MAJOR (X.0.0): Breaking changes (principle removal/redefinition)
- MINOR (0.X.0): New principles/sections
- PATCH (0.0.X): Clarifications, wording fixes

**Approval**: Project Architect MUST approve MINOR/MAJOR. Tech Lead can approve PATCH.

### Emergency Amendment Protocol

**Trigger**: Critical security vulnerability requiring immediate constitution update.

**Process**:
1. Security issue identified (CVSS ≥9.0 or active exploit)
2. Architect notified immediately (Slack/WhatsApp)
3. Emergency amendment drafted within 4 hours
4. Amendment approved via async vote (2 of 3: Architect, Tech Lead, Security Lead)
5. Constitution updated within 24 hours of discovery
6. Retrospective ADR created within 48 hours

**Version Bump**: PATCH if clarification, MINOR if new security requirement, MAJOR if principle change.

**Example**: If JWT vulnerability found, emergency amendment adds "JWT MUST use RS256 (not HS256)" to Phase II security requirements. Version: 1.2.0 → 1.3.0 (MINOR).

### Compliance Review

**PR Checklist** (Automated in CI):
- [ ] Code references generating spec (`@spec:` comments)
- [ ] Spec aligns with SDD principles
- [ ] Tech stack matches phase requirements
- [ ] Security standards enforced (automated scan passes)
- [ ] Testing requirements met (coverage ≥80%)
- [ ] PHR created and linked in PR description

**Enforcement**: CI MUST block PRs failing critical checks (P0/P1 violations). Overrides require architect approval in PR comments.

### Complexity Justification

Use `plan-template.md` Complexity Tracking section for violations.

**Examples Requiring Justification**:
- Additional architectural layer (e.g., repository pattern)
- Additional service (e.g., 4th microservice)
- Non-standard tech (e.g., different ORM)

**Approval**: Architect MUST approve complexity before implementation.

### Runtime Development Guidance

`CLAUDE.md` files MUST include:
- Automated compliance verification commands
- Spec reference comment format examples
- Phase-specific security/testing patterns
- Common violation examples and fixes

---

**Version**: 1.2.0 | **Ratified**: 2025-12-25 | **Last Amended**: 2025-12-25
