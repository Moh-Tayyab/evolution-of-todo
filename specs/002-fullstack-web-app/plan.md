# Implementation Plan: Phase II - Todo Full-Stack Web Application

**Branch**: `002-fullstack-web-app` | **Date**: 2026-01-05 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/002-fullstack-web-app/spec.md`
**Research**: [research.md](./research.md) | **Data Model**: [data-model.md](./data-model.md)

## Summary

Transform the Phase I console todo application into a modern, multi-user web application with persistent storage, responsive UI, and JWT-based authentication. The application implements 10 features (5 Basic + 5 Intermediate) including task CRUD operations, priorities, tags, search, filter, and sort capabilities.

**Technical Approach**:
- **Frontend**: Next.js 16+ with App Router, TypeScript, Tailwind CSS, Better Auth for JWT management
- **Backend**: FastAPI with SQLModel, async PostgreSQL (Neon), JWT verification middleware
- **Authentication**: JWT tokens issued by Better Auth, verified by FastAPI using shared BETTER_AUTH_SECRET
- **Database**: Neon Serverless PostgreSQL with proper user isolation via `user_id` foreign keys

## Technical Context

**Language/Version**:
- Frontend: TypeScript 5.6+, React 19+, Next.js 16.0+
- Backend: Python 3.13+

**Primary Dependencies**:
- Frontend: `next`, `react`, `react-dom`, `better-auth`, `zod`, `tailwindcss`
- Backend: `fastapi>=0.109.0`, `uvicorn[standard]>=0.27.0`, `sqlmodel>=0.0.14`, `asyncpg>=0.29.0`, `python-jose[cryptography]>=3.3.0`, `pydantic>=2.5.0`

**Storage**:
- Neon Serverless PostgreSQL with connection pooling
- Tables: `users` (Better Auth), `tasks`, `tags`, `task_tags` (junction)

**Testing**:
- Backend: `pytest>=7.4.0`, `pytest-asyncio>=0.23.0`, `httpx>=0.26.0`
- Frontend: `jest>=29.0.0`, `@testing-library/react>=14.0.0`, `@testing-library/jest-dom`
- Coverage targets: â‰¥80% backend, â‰¥70% frontend

**Target Platform**:
- Development: Local (frontend http://localhost:3000, backend http://localhost:8000)
- Production: Cloud-hosted (any VPS/PaaS supporting Node.js 18+ and Python 3.13+)

**Project Type**:
- Web application (monorepo with separate frontend and backend)

**Performance Goals**:
- API response time: p95 <200ms for CRUD operations
- Search/filter: p95 <500ms
- Task completion toggle: Visual feedback within 200ms
- Initial page load: <3 seconds on 4G mobile connection
- Support: 100 concurrent users without degradation

**Constraints**:
- Max 100 tasks per user (enforced at API level)
- Task title: 1-200 characters
- Task description: 0-2000 characters
- JWT token expiration: 24 hours
- Tag names: 1-50 characters, unique per user
- Responsive design: 320px - 1920px width support

**Scale/Scope**:
- Users: Unlimited (Neon free tier limits apply)
- Tasks: 100 per user maximum
- API endpoints: 11 total (6 tasks + 4 tags + 1 health)
- Database tables: 4 (users, tasks, tags, task_tags)
- Frontend pages: 4 (landing, signup, signin, dashboard)

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

### Phase II Constitution Requirements

**Tech Stack Compliance** (Principle VI, Phase-Specific Requirements):
- [x] Next.js 16+ (App Router, TypeScript, Tailwind)
- [x] FastAPI backend
- [x] SQLModel ORM
- [x] Neon Serverless PostgreSQL
- [x] Better Auth with JWT plugin

**Feature Scope Compliance** (Phase II Requirements):
- [x] Basic Features (5): Create Task, Delete Task, List Tasks, View Task Details, Mark as Complete
- [x] Intermediate Features (5): Priorities, Tags, Search, Filter, Sort

**Security Requirements** (Principle VI):
- [x] JWT authentication with 24h expiration
- [x] All user-scoped tables have `user_id` foreign key + index
- [x] Input validation via Pydantic (backend) + Zod (frontend)
- [x] HTTPS enforced (development: localhost exception)
- [x] Secrets in `.env` files (never committed to Git)

**Spec-Driven Development** (Principle I):
- [x] All code MUST include `@spec:` reference comments
- [x] CI enforces 100% spec traceability
- [x] Code generated by Claude Code from specs

**Stateless Design** (Principle IV):
- [x] No in-memory session state
- [x] All state persisted to PostgreSQL
- [x] JWT tokens for stateless authentication

**Code Standards** (Constitution - Code Standards):
- [x] SQLModel ORM only
- [x] Pydantic input validation on all endpoints
- [x] Consistent error format: `{"error": "...", "message": "...", "details": [...]}`
- [x] Auth middleware on all protected endpoints

### Phase II â†’ Phase III Transition Gate Checkpoints

These checkpoints will be validated before advancing to Phase III:

- [ ] All 10 features functional (manual test)
- [ ] E2E tests pass in CI
- [ ] Security scan: 0 HIGH/CRITICAL vulnerabilities
- [ ] JWT auth functional (signup, signin, signout)
- [ ] Database migrations tested (up + down)
- [ ] Test coverage: â‰¥80% backend, â‰¥70% frontend
- [ ] Spec traceability: 100% (automated check)
- [ ] Demo video recorded
- [ ] Phase II ADR created

**Result**: âœ… **CONSTITUTION COMPLIANT** - All requirements verified

## Project Structure

### Documentation (this feature)

```text
specs/002-fullstack-web-app/
â”œâ”€â”€ plan.md              # This file - architecture and design decisions
â”œâ”€â”€ spec.md              # Feature specification with user stories
â”œâ”€â”€ research.md          # Technology research and decision rationale
â”œâ”€â”€ data-model.md        # Database schema, entities, migrations
â”œâ”€â”€ quickstart.md        # Developer onboarding guide
â”œâ”€â”€ tasks.md             # Implementation tasks (user story breakdown)
â”œâ”€â”€ contracts/           # API contracts and OpenAPI specs
â”‚   â”œâ”€â”€ rest-endpoints.md
â”‚   â””â”€â”€ openapi.json
â””â”€â”€ checklists/          # Quality validation checklists
    â”œâ”€â”€ spec-quality.md  # Specification quality validation
    â””â”€â”€ implementation-readiness.md
```

### Source Code (repository root)

```text
/
â”œâ”€â”€ .specify/                    # SpecKit Plus configuration
â”‚   â”œâ”€â”€ memory/
â”‚   â”‚   â””â”€â”€ constitution.md      # Project constitution
â”‚   â””â”€â”€ templates/               # SpecKit templates
â”œâ”€â”€ specs/                       # All feature specifications
â”‚   â”œâ”€â”€ 001-console-todo-app/    # Phase I (completed)
â”‚   â””â”€â”€ 002-fullstack-web-app/   # Phase II (current)
â”œâ”€â”€ CLAUDE.md                    # Root AI instructions (project-wide)
â”œâ”€â”€ README.md                    # Project overview and setup
â”œâ”€â”€ docker-compose.yml           # Local development orchestration
â”‚
â”œâ”€â”€ frontend/                    # Next.js 16+ application
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ app/                 # App Router pages
â”‚   â”‚   â”‚   â”œâ”€â”€ layout.tsx       # Root layout with providers
â”‚   â”‚   â”‚   â”œâ”€â”€ page.tsx         # Landing page (redirect to signin/dashboard)
â”‚   â”‚   â”‚   â”œâ”€â”€ signup/
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ page.tsx     # Signup page
â”‚   â”‚   â”‚   â”œâ”€â”€ signin/
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ page.tsx     # Signin page
â”‚   â”‚   â”‚   â””â”€â”€ dashboard/
â”‚   â”‚   â”‚       â””â”€â”€ page.tsx     # Main task dashboard
â”‚   â”‚   â”œâ”€â”€ components/          # React components
â”‚   â”‚   â”‚   â”œâ”€â”€ auth/            # Authentication components
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ SignUpForm.tsx
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ SignInForm.tsx
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ SignOutButton.tsx
â”‚   â”‚   â”‚   â”œâ”€â”€ tasks/           # Task-related components
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ TaskList.tsx
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ TaskItem.tsx
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ TaskForm.tsx
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ DeleteConfirmation.tsx
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ PrioritySelector.tsx
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ TagInput.tsx
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ TagChip.tsx
â”‚   â”‚   â”‚   â”œâ”€â”€ search/          # Search/filter/sort components
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ SearchInput.tsx
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ FilterPanel.tsx
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ SortSelector.tsx
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ ActiveFilters.tsx
â”‚   â”‚   â”‚   â””â”€â”€ layout/          # Layout components
â”‚   â”‚   â”‚       â”œâ”€â”€ Header.tsx
â”‚   â”‚   â”‚       â””â”€â”€ ProtectedRoute.tsx
â”‚   â”‚   â”œâ”€â”€ lib/                 # Utilities and configurations
â”‚   â”‚   â”‚   â”œâ”€â”€ auth.ts          # Better Auth client configuration
â”‚   â”‚   â”‚   â”œâ”€â”€ api.ts           # API client with JWT attachment
â”‚   â”‚   â”‚   â”œâ”€â”€ validation.ts    # Zod schemas
â”‚   â”‚   â”‚   â””â”€â”€ utils.ts         # Helper functions
â”‚   â”‚   â””â”€â”€ types/               # TypeScript type definitions
â”‚   â”‚       â””â”€â”€ index.ts
â”‚   â”œâ”€â”€ tests/                   # Frontend tests
â”‚   â”‚   â”œâ”€â”€ components/          # Component tests
â”‚   â”‚   â”œâ”€â”€ integration/         # Integration tests
â”‚   â”‚   â””â”€â”€ __mocks__/           # Mock files
â”‚   â”œâ”€â”€ public/                  # Static assets
â”‚   â”œâ”€â”€ .env.local.example       # Environment variable template
â”‚   â”œâ”€â”€ .eslintrc.json           # ESLint configuration
â”‚   â”œâ”€â”€ package.json             # Dependencies and scripts
â”‚   â”œâ”€â”€ tailwind.config.ts       # Tailwind configuration
â”‚   â”œâ”€â”€ tsconfig.json            # TypeScript configuration
â”‚   â”œâ”€â”€ next.config.js           # Next.js configuration
â”‚   â””â”€â”€ CLAUDE.md                # Frontend-specific AI instructions
â”‚
â””â”€â”€ backend/                     # FastAPI application
    â”œâ”€â”€ src/
    â”‚   â”œâ”€â”€ models/              # SQLModel database models
    â”‚   â”‚   â”œâ”€â”€ __init__.py
    â”‚   â”‚   â”œâ”€â”€ task.py          # Task, Tag, TaskTag models
    â”‚   â”‚   â””â”€â”€ user.py          # User model (reference only, managed by Better Auth)
    â”‚   â”œâ”€â”€ schemas/             # Pydantic request/response schemas
    â”‚   â”‚   â”œâ”€â”€ __init__.py
    â”‚   â”‚   â”œâ”€â”€ task.py          # TaskCreate, TaskUpdate, TaskRead
    â”‚   â”‚   â””â”€â”€ tag.py           # TagCreate, TagUpdate, TagRead
    â”‚   â”œâ”€â”€ api/                 # API routes and dependencies
    â”‚   â”‚   â”œâ”€â”€ __init__.py
    â”‚   â”‚   â”œâ”€â”€ deps.py          # FastAPI dependencies (JWT verification)
    â”‚   â”‚   â””â”€â”€ routes/
    â”‚   â”‚       â”œâ”€â”€ __init__.py
    â”‚   â”‚       â”œâ”€â”€ tasks.py     # Task CRUD endpoints
    â”‚   â”‚       â”œâ”€â”€ tags.py      # Tag CRUD endpoints
    â”‚   â”‚       â””â”€â”€ health.py    # Health check endpoint
    â”‚   â”œâ”€â”€ middleware/          # Custom middleware
    â”‚   â”‚   â”œâ”€â”€ __init__.py
    â”‚   â”‚   â””â”€â”€ auth.py          # JWT verification middleware
    â”‚   â”œâ”€â”€ config.py            # Configuration from environment
    â”‚   â”œâ”€â”€ database.py          # Database connection and session
    â”‚   â””â”€â”€ main.py              # FastAPI application entry point
    â”œâ”€â”€ tests/                   # Backend tests
    â”‚   â”œâ”€â”€ unit/                # Unit tests
    â”‚   â”œâ”€â”€ integration/         # Integration tests
    â”‚   â”œâ”€â”€ contract/            # API contract tests
    â”‚   â””â”€â”€ conftest.py          # Pytest fixtures
    â”œâ”€â”€ .env.example             # Environment variable template
    â”œâ”€â”€ pyproject.toml           # Python project configuration
    â”œâ”€â”€ requirements.txt         # Python dependencies lock file
    â””â”€â”€ CLAUDE.md                # Backend-specific AI instructions
```

**Structure Decision**: Monorepo with separate `frontend/` and `backend/` directories. This structure provides:
- Clear separation of concerns between frontend and backend code
- Independent deployment and scaling
- Shared `specs/` directory for cross-cutting specifications
- Root-level `CLAUDE.md` for project-wide conventions
- Technology-specific `CLAUDE.md` files in each subdirectory

## Architecture Decisions

### 1. JWT Authentication Flow

**Decision**: Better Auth (frontend) issues JWT tokens â†’ FastAPI (backend) verifies using shared secret.

**Flow Diagram**:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          JWT AUTHENTICATION FLOW                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  User Browser                    Frontend (Next.js)              Backend (FastAPI)
       â”‚                                â”‚                                â”‚
       â”‚  1. Click "Sign In"            â”‚                                â”‚
       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                                â”‚
       â”‚                                â”‚                                â”‚
       â”‚                    2. Better Auth:                        â”‚
       â”‚                    - Validate credentials                â”‚
       â”‚                    - Create JWT token                     â”‚
       â”‚                    - Token includes:                     â”‚
       â”‚                      * sub: user_id (UUID)               â”‚
       â”‚                      * exp: expiration (24h)             â”‚
       â”‚                      * iat: issued at                    â”‚
       â”‚                    - Sign with BETTER_AUTH_SECRET        â”‚
       â”‚                                â”‚                                â”‚
       â”‚  3. Redirect to dashboard       â”‚                                â”‚
       â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                                â”‚
       â”‚                                â”‚                                â”‚
       â”‚  4. Dashboard loads             â”‚                                â”‚
       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                                â”‚
       â”‚                                â”‚                                â”‚
       â”‚                    5. Extract JWT from session:          â”‚
       â”‚                    const session = await getSession()     â”‚
       â”‚                    const token = session?.user?.token      â”‚
       â”‚                                â”‚                                â”‚
       â”‚  6. API Call: GET /api/{user_id}/tasks                            â”‚
       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
       â”‚    Header: Authorization: Bearer <jwt_token>                      â”‚
       â”‚                                â”‚                                â”‚
       â”‚                                â”‚                        7. FastAPI receives:
       â”‚                                â”‚                        - Extract token from
       â”‚                                â”‚                          Authorization header
       â”‚                                â”‚                        - Verify JWT signature:
       â”‚                                â”‚                          payload = jwt.decode(
       â”‚                                â”‚                            token,
       â”‚                                â”‚                            BETTER_AUTH_SECRET,
       â”‚                                â”‚                            algorithms=["HS256"]
       â”‚                                â”‚                          )
       â”‚                                â”‚                        - Validate expiration
       â”‚                                â”‚                        - Extract user_id from sub
       â”‚                                â”‚                        - Compare with path user_id
       â”‚                                â”‚                                â”‚
       â”‚                                â”‚                    8. If mismatch â†’ 403 Forbidden
       â”‚                                â”‚                    If valid â†’ process request
       â”‚                                â”‚                                â”‚
       â”‚  9. Response: { tasks: [...] }                                              â”‚
       â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
       â”‚                                â”‚                                â”‚
       â”‚  10. Render task list            â”‚                                â”‚
       â”‚                                â”‚                                â”‚
```

**Key Implementation Details**:

**Frontend (Better Auth Configuration)**:
```typescript
// frontend/src/lib/auth.ts
import { betterAuth } from "better-auth"

export const auth = betterAuth({
  baseURL: process.env.NEXT_PUBLIC_API_URL,
  plugins: [
    jwt({
      // JWT issued with 24-hour expiration
      expiresIn: "24h",
      // Signed with BETTER_AUTH_SECRET (from .env.local)
    })
  ]
})
```

**Frontend API Client (JWT Attachment)**:
```typescript
// frontend/src/lib/api.ts
async function apiCall(endpoint: string, options?: RequestInit) {
  // Get JWT from Better Auth session
  const session = await auth.api.getSession()
  const token = session?.user?.token

  return fetch(`${API_URL}${endpoint}`, {
    ...options,
    headers: {
      ...options?.headers,
      ...(token ? { Authorization: `Bearer ${token}` } : {})
    }
  })
}
```

**Backend JWT Verification (FastAPI Dependency)**:
```python
# backend/src/api/deps.py
from fastapi import Header, HTTPException, Depends
from jose import jwt, JWTError
from backend.src.config import settings

async def verify_jwt(authorization: str = Header(...)) -> dict:
    """Extract and verify JWT from Authorization header."""
    try:
        token = authorization.replace("Bearer ", "")
        payload = jwt.decode(
            token,
            settings.BETTER_AUTH_SECRET,
            algorithms=["HS256"]
        )
        return payload
    except JWTError as e:
        raise HTTPException(status_code=401, detail="Invalid token")

async def get_current_user_id(
    user_id: str,  # From path parameter
    jwt_payload: dict = Depends(verify_jwt)
) -> str:
    """Validate that path user_id matches JWT subject."""
    if jwt_payload["sub"] != user_id:
        raise HTTPException(status_code=403, detail="Forbidden")
    return user_id
```

**Environment Variables**:
```bash
# frontend/.env.local
BETTER_AUTH_SECRET=your-super-secret-key-min-32-chars
NEXT_PUBLIC_API_URL=http://localhost:8000

# backend/.env
BETTER_AUTH_SECRET=your-super-secret-key-min-32-chars  # SAME VALUE
DATABASE_URL=postgresql://user:pass@ep-cool-neon.us-east-2.aws.neon.tech/dbname
CORS_ORIGINS=http://localhost:3000
```

**Security Considerations**:
- `BETTER_AUTH_SECRET` MUST be at least 32 characters
- Secret MUST be identical between frontend and backend
- Secret MUST never be committed to Git (use `.env` files)
- Token expiration: 24 hours (configurable)
- Algorithm: HS256 (HMAC with SHA-256)

### 2. Monorepo Structure Rationale

**Decision**: Monorepo with separate `frontend/` and `backend/` directories.

**Rationale**:

| Consideration | Monorepo Choice | Alternative | Trade-off |
|---------------|-----------------|-------------|-----------|
| **Spec Traceability** | âœ… Single `specs/` directory for both frontend and backend | Separate repos with separate specs | Easier to maintain cross-cutting specs |
| **Shared Types** | âœ… TypeScript types can be referenced from both sides | Need to publish/shared types package | Avoids duplication, version alignment |
| **Unified CI/CD** | âœ… Single pipeline for frontend + backend tests | Separate pipelines per repo | Simpler infrastructure |
| **Deployment Independence** | âœ… Frontend and backend deploy separately | Monolithic deployment | Flexibility in scaling |
| **Technology Coupling** | âš ï¸ Python and Node.js in same repo | Tech-agnostic repos | Requires polyglot CI |
| **Repository Size** | âš ï¸ Larger clone, longer CI | Smaller per-repo clones | Acceptable for small projects |

**Alternatives Considered**:
1. **Separate Repositories** (`todo-frontend`, `todo-backend`):
   - Pros: Technology isolation, smaller clones, independent CI/CD
   - Cons: Spec synchronization complexity, shared types need npm package, harder cross-cutting changes
   - Rejected Because: Hackathon scope benefits from unified specs and simpler infrastructure

2. **Polyrepo with Shared Spec Repo** (`todo-specs`, `todo-frontend`, `todo-backend`):
   - Pros: Clean separation, technology isolation
   - Cons: Complex PR coordination across 3 repos, spec drift risk
   - Rejected Because: Overkill for hackathon scope

**Decision**: Monorepo is optimal for this project size and spec-driven development approach.

### 3. Database Schema Decisions

**Decision**: Neon Serverless PostgreSQL with SQLModel ORM.

**Schema Overview**:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              DATABASE SCHEMA                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Table: users (managed by Better Auth)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ id (UUID PK) â”‚ email (VARCHAR UNIQUE) â”‚ password_hash â”‚ name â”‚ created_at  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                     â”‚ 1:N
                                     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                     â–¼                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Table: tasks                                                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id (UUID PK) â”‚ user_id (FK) â”‚ title â”‚ description â”‚ priority â”‚ completed â”‚  â”‚
â”‚ created_at â”‚ updated_at â”‚                                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                     â”‚ N:M
                                     â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Table: tags                                                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id (UUID PK) â”‚ user_id (FK) â”‚ name (UNIQUE per user) â”‚ color â”‚ created_at â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Table: task_tags (junction)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ task_id (FK â†’ tasks.id) â”‚ tag_id (FK â†’ tags.id) â”‚ PRIMARY KEY (task_id, tag_id) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Key Design Decisions**:

1. **UUID Primary Keys**:
   - Pros: Globally unique, no ID collisions, secure (non-guessable)
   - Cons: Larger storage (16 bytes vs 4/8 bytes for integer)
   - Decision: UUIDs for security and distributed system compatibility

2. **`user_id` Foreign Key + Index**:
   - Every user-owned table has `user_id` foreign key
   - Indexed for efficient user-scoped queries
   - Enables data isolation at database level

3. **Junction Table for Many-to-Many**:
   - `task_tags` table for Task â†” Tag relationship
   - Composite primary key prevents duplicate associations
   - CASCADE delete for automatic cleanup

4. **Trigger for `updated_at`**:
   - PostgreSQL trigger auto-updates `updated_at` on row modification
   - Eliminates application-level timestamp management

5. **Unique Constraint on Tag Names**:
   - `(user_id, name)` unique constraint
   - Each user has their own tag namespace
   - Prevents confusion from duplicate tag names

**Migration Strategy**:
- Use Alembic for versioned migrations
- Migration files in `backend/src/migrations/`
- Run `alembic upgrade head` on deployment

### 4. API Contract Patterns

**Decision**: RESTful API with `/api/{user_id}/tasks` pattern and consistent error format.

**Endpoint Patterns**:

| Pattern | Endpoint | Purpose | Example |
|---------|----------|---------|---------|
| **List** | `GET /api/{user_id}/tasks` | Get all tasks (with query params) | `GET /api/123/tasks?status=completed` |
| **Create** | `POST /api/{user_id}/tasks` | Create new resource | `POST /api/123/tasks` with body |
| **Read** | `GET /api/{user_id}/tasks/{id}` | Get single resource | `GET /api/123/tasks/456` |
| **Update** | `PUT /api/{user_id}/tasks/{id}` | Full update | `PUT /api/123/tasks/456` with body |
| **Patch** | `PATCH /api/{user_id}/tasks/{id}` | Partial update (toggle) | `PATCH /api/123/tasks/456` with `{completed: true}` |
| **Delete** | `DELETE /api/{user_id}/tasks/{id}` | Remove resource | `DELETE /api/123/tasks/456` |

**Query Parameters for List Endpoints**:
```typescript
interface TaskListParams {
  search?: string;      // Search in title, description, tags
  status?: 'all' | 'completed' | 'incomplete';
  priority?: 'high' | 'medium' | 'low';
  tags?: string[];      // Tag IDs (comma-separated in URL)
  sort?: 'created_at' | 'priority' | 'title';
  order?: 'asc' | 'desc';
}
```

**Error Response Format**:
```json
{
  "error": "error_code",
  "message": "Human-readable error message",
  "details": ["Additional context", "Field-specific errors"]
}
```

**Error Codes**:
| HTTP Status | Error Code | Description |
|-------------|------------|-------------|
| 400 | `validation_error` | Request body validation failed |
| 401 | `unauthorized` | Missing or invalid JWT |
| 403 | `forbidden` | user_id mismatch (JWT â‰  path param) |
| 404 | `not_found` | Resource not found |
| 422 | `unprocessable_entity` | Business logic violation (e.g., task limit reached) |

### 5. Frontend Component Architecture

**Decision**: Server Components for pages, Client Components for interactive elements.

**Component Hierarchy**:
```
App (layout.tsx - Server Component)
â””â”€â”€ DashboardPage (page.tsx - Server Component)
    â”œâ”€â”€ Header (Client Component)
    â”‚   â”œâ”€â”€ Logo
    â”‚   â”œâ”€â”€ UserMenu
    â”‚   â””â”€â”€ SignOutButton
    â”œâ”€â”€ SearchBar (Client Component)
    â”‚   â”œâ”€â”€ SearchInput
    â”‚   â”œâ”€â”€ FilterPanel
    â”‚   â”œâ”€â”€ SortSelector
    â”‚   â””â”€â”€ ActiveFilters
    â”œâ”€â”€ TaskList (Client Component)
    â”‚   â”œâ”€â”€ TaskItem (repeated)
    â”‚   â”‚   â”œâ”€â”€ Checkbox
    â”‚   â”‚   â”œâ”€â”€ Title
    â”‚   â”‚   â”œâ”€â”€ PriorityBadge
    â”‚   â”‚   â”œâ”€â”€ TagChips
    â”‚   â”‚   â”œâ”€â”€ EditButton
    â”‚   â”‚   â””â”€â”€ DeleteButton
    â”‚   â””â”€â”€ EmptyState
    â”œâ”€â”€ TaskForm (Client Component - Modal)
    â”‚   â”œâ”€â”€ TitleInput
    â”‚   â”œâ”€â”€ DescriptionTextarea
    â”‚   â”œâ”€â”€ PrioritySelector
    â”‚   â”œâ”€â”€ TagInput
    â”‚   â””â”€â”€ ActionButtons
    â””â”€â”€ DeleteConfirmation (Client Component - Modal)
```

**State Management Strategy**:
- **Authentication**: Better Auth hooks (`useSession()`)
- **Tasks**: React Server Components + Client Components with `useState` for UI state
- **No Redux/Zustand**: Simplicity for this scope, React Context sufficient

**Data Fetching**:
- Server Components: `fetch()` with Next.js caching
- Client Components: API client from `@/lib/api.ts`

### 6. Security Architecture

**Decision**: JWT-based stateless authentication with defense-in-depth.

**Security Layers**:

1. **Transport Layer**:
   - HTTPS in production (enforced)
   - CORS: Only allow `NEXT_PUBLIC_API_URL` in development
   - Backend CORS configured with `CORS_ORIGINS` env var

2. **Authentication Layer**:
   - JWT tokens with HS256 algorithm
   - 24-hour expiration
   - Signed with `BETTER_AUTH_SECRET` (â‰¥32 characters)

3. **Authorization Layer**:
   - Every request validates `user_id` (JWT `sub` === path `user_id`)
   - Database-level isolation via `user_id` foreign keys
   - API never returns data from other users

4. **Input Validation**:
   - Frontend: Zod schemas (client-side validation)
   - Backend: Pydantic schemas (server-side validation)
   - Never trust client input

5. **Output Encoding**:
   - React automatically escapes JSX
   - Prevents XSS attacks

**Security Headers** (FastAPI):
```python
# backend/src/main.py
from fastapi.middleware.cors import CORSMiddleware
from fastapi.middleware.trustedhost import TrustedHostMiddleware

app.add_middleware(
    CORSMiddleware,
    allow_origins=settings.CORS_ORIGINS,
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

app.add_middleware(
    TrustedHostMiddleware,
    allowed_hosts=["localhost", "*.yourdomain.com"]
)
```

**Secrets Management**:
- `.env` files for local development (never committed)
- Environment variables in production
- `BETTER_AUTH_SECRET` MUST be â‰¥32 characters
- Database URL in `.env` only

### 7. Performance Optimization

**Decision**: Database indexes + query optimization + frontend caching.

**Backend Optimizations**:

1. **Database Indexes**:
```sql
-- User-scoped queries (most common)
CREATE INDEX idx_tasks_user_id ON tasks(user_id);
CREATE INDEX idx_tags_user_id ON tags(user_id);

-- Filtering
CREATE INDEX idx_tasks_user_priority ON tasks(user_id, priority);
CREATE INDEX idx_tasks_user_completed ON tasks(user_id, completed);

-- Tag search
CREATE INDEX idx_task_tags_task_id ON task_tags(task_id);
CREATE INDEX idx_task_tags_tag_id ON task_tags(tag_id);
```

2. **Query Optimization**:
   - Use SQLModel `select()` with explicit column selection
   - Avoid `SELECT *` queries
   - Use `join()` for eager loading relationships
   - Pagination for large result sets (future enhancement)

3. **Connection Pooling**:
   - Neon provides built-in connection pooling
   - Configure pool size in `DATABASE_URL`

**Frontend Optimizations**:

1. **Code Splitting**:
   - Next.js App Router automatically splits by route
   - Dynamic imports for heavy components

2. **Image Optimization**:
   - `next/image` for automatic optimization

3. **Caching**:
   - Next.js ISR (Incremental Static Regeneration) for static content
   - Client-side caching for API responses (consider SWR in future)

4. **Bundle Size**:
   - Tree-shaking via Next.js
   - Tailwind CSS purges unused styles

## Complexity Tracking

> No constitution violations requiring justification. All design decisions follow constitution principles.

**Simplicity Maintained**:
- âœ… No additional architectural layers (no repository pattern, no service layer)
- âœ… Direct SQLModel database access
- âœ… Standard FastAPI routing patterns
- âœ… React state management (no Redux/Zustand)
- âœ… Native fetch for API calls (no axios)

**Justified Complexity**:
- N/A (all complexity is baseline for full-stack web application)

## ADR Suggestions

The following architectural decisions warrant ADR documentation:

ğŸ“‹ **JWT Cross-Service Authentication**: Document reasoning and tradeoffs for Better Auth (frontend) + FastAPI (backend) JWT pattern. Run `/sp.adr jwt-auth-integration`

ğŸ“‹ **Monorepo Structure**: Document rationale for monorepo vs polyrepo decision. Run `/sp.adr monorepo-structure`

ğŸ“‹ **SQLModel vs SQLAlchemy**: Document choice of SQLModel over raw SQLAlchemy. Run `/sp.adr orm-choice`

## Risk Analysis

| Risk | Likelihood | Impact | Mitigation |
|------|------------|--------|------------|
| JWT secret exposure | Low | High | Use `.env` files, never commit secrets, rotate periodically |
| Neon cold start latency | Medium | Low | Enable connection pooling, use keep-alive queries |
| Better Auth API changes | Low | Medium | Pin version in `package.json`, check changelog before updates |
| CORS misconfiguration | High | Low | Configure `CORS_ORIGINS` in both dev and production |
| Database migration failure | Low | High | Test migrations in development, use Alembic versioning |
| Token expiration during session | Medium | Medium | Implement token refresh or re-authentication flow |
| User data leak (cross-user) | Low | Critical | JWT validation + database-level `user_id` isolation, extensive testing |

## Dependencies

### External Services
- **Neon PostgreSQL**: Serverless database, free tier sufficient for development
- **Better Auth**: Open-source authentication library for Next.js

### Frontend Dependencies
```json
{
  "dependencies": {
    "next": "^16.0.0",
    "react": "^19.0.0",
    "react-dom": "^19.0.0",
    "better-auth": "^1.0.0",
    "zod": "^3.22.0"
  },
  "devDependencies": {
    "typescript": "^5.6.0",
    "@types/react": "^19.0.0",
    "tailwindcss": "^3.4.0",
    "jest": "^29.0.0",
    "@testing-library/react": "^14.0.0"
  }
}
```

### Backend Dependencies
```toml
[project]
dependencies = [
    "fastapi>=0.109.0",
    "uvicorn[standard]>=0.27.0",
    "sqlmodel>=0.0.14",
    "asyncpg>=0.29.0",
    "python-jose[cryptography]>=3.3.0",
    "pydantic>=2.5.0",
    "pydantic-settings>=2.1.0",
]

[project.optional-dependencies]
dev = [
    "pytest>=7.4.0",
    "pytest-asyncio>=0.23.0",
    "httpx>=0.26.0",
]
```

## Deployment Considerations

### Development Environment
```bash
# Using docker-compose.yml
docker-compose up
# Starts: PostgreSQL, FastAPI (port 8000), Next.js (port 3000)
```

### Production Deployment

**Frontend**:
- Platform: Vercel, Netlify, or any Node.js 18+ host
- Build: `npm run build`
- Start: `npm start`
- Environment: `NEXT_PUBLIC_API_URL`, `BETTER_AUTH_SECRET`

**Backend**:
- Platform: Railway, Render, Fly.io, or any Python 3.13+ host
- Start: `uvicorn backend.src.main:app --host 0.0.0.0 --port 8000`
- Environment: `DATABASE_URL`, `BETTER_AUTH_SECRET`, `CORS_ORIGINS`

**Database**:
- Platform: Neon PostgreSQL (managed service)
- Migrations: `alembic upgrade head`

## Next Steps

1. âœ… **Specification Complete** - `spec.md` with user stories and requirements
2. âœ… **Research Complete** - `research.md` with technology decisions
3. âœ… **Data Model Complete** - `data-model.md` with schema and migrations
4. âœ… **Architecture Plan Complete** - This document (`plan.md`)
5. â­ï¸ **Tasks** - Run `/sp.tasks` to generate implementation tasks
6. â­ï¸ **Implementation** - Run `/sp.implement` to begin coding

---

**Plan Version**: 1.0
**Last Updated**: 2026-01-05
**Status**: âœ… Complete and Constitution-Compliant
